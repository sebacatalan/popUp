<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="../images/logo-icon.png">
    <title>Dirección de Crédito y Recaudación - UCT Clone</title>
    <!-- Tailwind CSS para estilos rápidos y precisos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos de FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="styles.css">
    <!-- Estilos del Chatbot (Aislados) -->
    <link rel="stylesheet" href="chatbot-styles.css">
    <!-- Marked.js para renderizar Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gray-50 overflow-x-hidden relative">

    <!-- BOTONES FLOTANTES LATERALES (ASIDE) -->
    <aside class="fixed right-0 top-1/4 z-50 flex flex-col gap-2">
        <button class="bg-[#004e7c] text-white p-3 rounded-l-md shadow-lg hover:bg-blue-800 transition" aria-label="Accesibilidad">
            <i class="fas fa-universal-access fa-lg"></i>
        </button>
        <button class="bg-[#0084b6] text-white p-3 rounded-l-md shadow-lg hover:bg-blue-600 transition" aria-label="Buscar">
            <i class="fas fa-search fa-lg"></i>
        </button>
    </aside>

    <!-- ENCABEZADO PRINCIPAL (HEADER) -->
    <header class="w-full bg-white shadow-sm">
        
        <!-- BARRA SUPERIOR (TOP BAR) -->
        <div class="bg-[#0084b6] text-white text-[10px] font-semibold tracking-wider py-1 px-4 md:px-12">
            <div class="max-w-7xl mx-auto flex flex-wrap justify-between items-center">
                <!-- Enlaces Izquierda -->
                <nav aria-label="Menú Superior" class="hidden md:flex gap-4 divide-x divide-blue-400/50">
                    <a href="#" class="hover:underline px-2">CONECTA</a>
                    <a href="#" class="hover:underline px-2">UCT AL DÍA</a>
                    <a href="#" class="hover:underline px-2">COMUNIDAD UCT</a>
                    <a href="#" class="hover:underline px-2">CENTRO DE AYUDA</a>
                    <a href="#" class="hover:underline px-2">DIRECTORIO</a>
                    <a href="#" class="hover:underline px-2">WEBMAIL</a>
                    <a href="#" class="hover:underline px-2">INTRANET</a>
                    <a href="#" class="hover:underline px-2">TVUCT</a>
                </nav>
                <!-- Iconos Social Derecha -->
                <div class="flex items-center gap-3 ml-auto">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                    <a href="#"><i class="fab fa-flickr"></i></a>
                    <a href="#"><i class="fas fa-rss"></i></a>
                </div>
            </div>
        </div>

        <!-- BARRA DE NAVEGACIÓN (NAVBAR) -->
        <div class="max-w-7xl mx-auto py-4 px-4 md:px-12 flex justify-between items-center">
            <!-- Logo -->
            <img src="../images/logo_uct_gris.png" alt="Logo UCT" class="h-12 w-auto">

            <!-- Menú Central -->
            <nav class="hidden lg:flex gap-6 text-gray-500 text-sm font-medium">
                <a href="#" class="hover:text-[#0076a8]">Inicio</a>
                <div class="relative group cursor-pointer hover:text-[#0076a8] flex items-center gap-1">
                    Dirección <i class="fas fa-chevron-down text-xs"></i>
                </div>
                <div class="relative group cursor-pointer hover:text-[#0076a8] flex items-center gap-1">
                    Estudiantes <i class="fas fa-chevron-down text-xs"></i>
                </div>
                <div class="relative group cursor-pointer hover:text-[#0076a8] flex items-center gap-1">
                    Ex-alumnos <i class="fas fa-chevron-down text-xs"></i>
                </div>
                <a href="#" class="hover:text-[#0076a8]">Gestión de Cobranza</a>
                <a href="#" class="hover:text-[#0076a8]">Normativa Legal</a>
                <div class="relative group cursor-pointer hover:text-[#0076a8] flex items-center gap-1">
                    Contáctenos <i class="fas fa-chevron-down text-xs"></i>
                </div>
            </nav>

            <!-- Botón de Pago -->
            <a href="#" class="btn-outline-blue font-bold py-2 px-6 uppercase text-sm flex items-center gap-4">
                <div class="flex flex-col leading-none text-left">
                    <span>PAGO</span>
                    <span>AQUÍ</span>
                </div>
                <i class="fas fa-chevron-right"></i>
            </a>
            
            <!-- Mobile Menu Button -->
            <button class="lg:hidden text-gray-600 text-2xl">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL (MAIN) -->
    <main>
        <!-- SECCIÓN HERO (BANNER DIVIDIDO) -->
        <section class="flex flex-col lg:flex-row w-full h-auto lg:h-[450px]">
            
            <!-- Mitad Izquierda: Azul sólido -->
            <article class="w-full lg:w-1/2 uct-blue flex items-center justify-center lg:justify-end px-8 py-16 lg:py-0 lg:pr-16 relative overflow-hidden">
                <div class="text-right lg:text-left z-10 max-w-md">
                    <h1 class="text-white text-4xl lg:text-5xl font-extrabold uppercase leading-tight tracking-tight">
                        Dirección <br>
                        <span class="uct-yellow">De Crédito y</span> <br>
                        <span class="uct-yellow">Recaudación</span>
                    </h1>
                </div>
                <!-- Decoración sutil de fondo -->
                <div class="absolute -left-10 -bottom-10 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl"></div>
            </article>

            <!-- Mitad Derecha: Imagen y CTA -->
            <article class="w-full lg:w-1/2 relative bg-gray-200">
                <!-- Imagen de fondo (Placeholder) -->
                <img src="https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1470&q=80" 
                     alt="Estudiante pagando online" 
                     class="w-full h-full object-cover">
                
                <!-- Overlay Degradado -->
                <div class="absolute inset-0 bg-gradient-to-r from-blue-900/40 to-transparent"></div>

                <!-- Contenido Superpuesto -->
                <div class="absolute inset-0 flex flex-col justify-center items-center text-center text-white px-4">
                    <h2 class="text-3xl font-bold uppercase mb-1 drop-shadow-md">Paga tu cuota online</h2>
                    <p class="text-xl font-semibold mb-6 drop-shadow-md">pagosweb.uct.cl</p>
                    
                    <p class="max-w-md text-sm mb-8 drop-shadow-md hidden sm:block">
                        A través de nuestra web podrás acceder a la información de los distintos medios de pago y recomendarte que uses nuestro portal de pagos online.
                    </p>

                    <button class="bg-[#0076a8] hover:bg-[#005f89] text-white font-bold py-3 px-10 rounded-full shadow-lg transition transform hover:scale-105 uppercase tracking-wide">
                        Aquí
                    </button>
                </div>

                <!-- Flechas de Carrusel -->
                <button class="absolute left-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white text-4xl">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white text-4xl">
                    <i class="fas fa-chevron-right"></i>
                </button>
                
                <!-- Barra amarilla derecha (decorativa) -->
                <div class="absolute right-0 top-0 bottom-0 w-8 uct-yellow-bg hidden xl:block"></div>
            </article>
        </section>

        <!-- SECCIÓN INFERIOR (VIDEO/INFO CARD) -->
        <section class="py-12 px-4 bg-white flex justify-center">
            <article class="max-w-2xl w-full bg-white shadow-xl rounded-lg overflow-hidden border border-gray-100">
                <!-- Encabezado de tarjeta con Logo -->
                <div class="bg-[#2d3748] p-6 flex items-start justify-between relative">
                    <div class="z-10">
                        <div class="flex items-center gap-2 mb-4">
                             <div class="w-8 h-8 rounded-full border border-yellow-400 bg-blue-900 flex items-center justify-center text-white text-[8px]">
                                UCT
                            </div>
                             <div class="flex flex-col leading-tight text-white">
                                <span class="text-[10px] uppercase">Universidad</span>
                                <span class="text-[10px] uppercase">Católica de</span>
                                <span class="text-[10px] uppercase">Temuco</span>
                            </div>
                        </div>
                        <h3 class="text-white text-lg font-bold">Presencial</h3>
                        <p class="text-yellow-400 text-xl font-extrabold uppercase">Pasaje</p>
                        <p class="text-yellow-400 text-xl font-extrabold uppercase">El Bosque 697</p>
                    </div>
                    
                    <!-- Imagen de fondo de la tarjeta (Edificio) -->
                    <div class="absolute right-0 top-0 bottom-0 w-2/3">
                         <img src="https://images.unsplash.com/photo-1541339907198-e08756dedf3f?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" 
                              class="w-full h-full object-cover opacity-80" alt="Edificio UCT">
                    </div>
                </div>

                <!-- Pie de tarjeta (Simulación reproductor) -->
                <div class="bg-[#dba718] p-3 flex items-center justify-between text-[#2d3748]">
                    <div class="flex items-center gap-2">
                        <button class="hover:text-white transition"><i class="fas fa-play"></i></button>
                        <div class="h-1 w-24 bg-black/20 rounded-full overflow-hidden">
                            <div class="h-full w-1/2 bg-white"></div>
                        </div>
                        <span class="text-xs font-mono">0:19 / 0:19</span>
                        <button><i class="fas fa-volume-up"></i></button>
                    </div>
                    
                    <div class="text-sm font-bold uppercase tracking-wide">
                        Correo: <span class="font-black">dcu@uct.cl</span>
                    </div>

                    <button><i class="fas fa-expand"></i></button>
                </div>
            </article>
        </section>
    </main>

    <!-- ============================================
         CÓDIGO DEL CHATBOT - INTEGRADO
         ============================================ -->
    
    <!-- Mensaje de ayuda para hacer el bot más visible -->
    <div class="chat-help-message" id="chat-help-message">
        ¿Necesitas Ayuda?
    </div>

    <button id="open-chat-button" class="chat-open-button">
        <i class="fa-solid fa-comment-dots"></i>
    </button>

    <div id="chatbot-modal" class="chatbot-modal">
        <div class="chat-header">
            <div class="header-content">
                <img src="https://recursos.uct.cl/wp-content/uploads/logouct_blanco.png"
                    alt="Logo Universidad Católica de Temuco" class="header-logo" />
            </div>
            <button id="close-chat-button" class="chat-close-button">
                <i class="fa-regular fa-circle-xmark fa-fw"></i>
            </button>
        </div>

        <!-- Pantalla de autenticación -->
        <div id="auth-screen" class="auth-screen">

            <h2 class="auth-title">Acceso al Asistente Virtual</h2>
            <p class="auth-description">
                Inicia sesión con tus credenciales institucionales para acceder al chatbot
            </p>

            <!-- Formulario Institucional -->
            <form id="auth-form" class="auth-form">
                <input type="email" id="email-input" class="auth-input" placeholder="Correo institucional"
                    autocomplete="email" required />
                <div class="password-input-wrapper">
                    <input type="password" id="password-input" class="auth-input" placeholder="Contraseña"
                        autocomplete="current-password" required />
                    <button type="button" class="password-toggle" id="toggle-password" aria-label="Mostrar contraseña">
                        <i class="fa-regular fa-eye"></i>
                    </button>
                </div>
                <div id="auth-error" class="auth-error hidden"></div>
                <button type="submit" class="auth-button">
                    Iniciar sesión
                </button>
            </form>

            <!-- Divisor -->
            <div class="auth-divider">
                <span>O</span>
            </div>

            <!-- Formulario Invitado -->
            <form id="guest-form" class="auth-form">
                <input type="email" id="guest-email-input" class="auth-input" placeholder="Correo de invitado/a"
                    required />
                <div id="guest-auth-error" class="auth-error hidden"></div>
                <button type="submit" class="auth-button guest-button">
                    Entrar como invitado/a
                </button>
            </form>
        </div>

        <!-- Pantalla del chat (oculta inicialmente) -->
        <div id="chat-messages" class="chat-messages hidden">
            <!-- Botón flotante de feedback -->
            <div id="feedback-trigger" class="feedback-trigger hidden">
                <button class="feedback-trigger-btn" id="open-feedback-btn">
                    <i class="fa-regular fa-star"></i>
                    ¿Te ayudé? Valora mi atención
                </button>
            </div>
        </div>

        <!-- Modal de feedback -->
        <div id="feedback-overlay" class="feedback-overlay"></div>
        <div id="feedback-modal" class="feedback-modal">
            <div class="feedback-modal-header">
                <div class="feedback-modal-title">Valorar atención</div>
                <button class="feedback-close-btn" id="close-feedback-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="feedback-modal-content" id="feedback-modal-content"></div>
        </div>

        <div id="suggested-questions" class="suggested-questions hidden"></div>

        <div id="chat-input-area" class="chat-input-area hidden">
            <form id="chat-form" class="chat-form">
                <input type="text" id="chat-input" class="chat-input" placeholder="Escribe tu mensaje..."
                    autocomplete="off" />
                <button type="submit" class="chat-send-button">
                    <i class="fa-solid fa-paper-plane fa-fw"></i>
                </button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const N8N_WEBHOOK_URL = "https://skynet.uct.cl/webhook/de698bbd-b6fb-4c84-a769-fc238fa2566a";
            const N8N_FEEDBACK_URL = "https://skynet.uct.cl/webhook/013cf19f-4374-4e3d-8edc-9303c71ece90";

            const openChatButton = document.getElementById("open-chat-button");
            const closeChatButton = document.getElementById("close-chat-button");
            const chatbotModal = document.getElementById("chatbot-modal");
            const chatMessages = document.getElementById("chat-messages");
            const chatForm = document.getElementById("chat-form");
            const chatInput = document.getElementById("chat-input");
            const suggestedQuestionsContainer = document.getElementById("suggested-questions");

            // Elementos de autenticación
            const authScreen = document.getElementById("auth-screen");
            const authForm = document.getElementById("auth-form");
            const emailInput = document.getElementById("email-input");
            const passwordInput = document.getElementById("password-input");
            const togglePasswordButton = document.getElementById("toggle-password");
            const authError = document.getElementById("auth-error");
            const chatInputArea = document.getElementById("chat-input-area");

            // Elementos para invitado
            const guestForm = document.getElementById("guest-form");
            const guestEmailInput = document.getElementById("guest-email-input");
            const guestAuthError = document.getElementById("guest-auth-error");

            // Elementos de feedback - usar getters dinámicos para que se actualicen después del logout
            const getFeedbackTrigger = () => document.getElementById("feedback-trigger");
            const getOpenFeedbackBtn = () => document.getElementById("open-feedback-btn");
            const closeFeedbackBtn = document.getElementById("close-feedback-btn");
            const feedbackOverlay = document.getElementById("feedback-overlay");
            const feedbackModal = document.getElementById("feedback-modal");
            const feedbackModalContent = document.getElementById("feedback-modal-content");

            // Mensaje de ayuda
            const chatHelpMessage = document.getElementById("chat-help-message");

            let isChatInitialized = false;
            let userEmail = "";
            let sessionId = "";
            let lastUserQuestion = "";
            let lastBotResponse = "";
            let feedbackTriggerShouldBeVisible = false;
            let helpMessageClosed = false;

            // Toggle mostrar/ocultar contraseña
            togglePasswordButton.addEventListener("click", () => {
                const type = passwordInput.getAttribute("type") === "password" ? "text" : "password";
                passwordInput.setAttribute("type", type);
                const icon = togglePasswordButton.querySelector("i");
                if (type === "password") {
                    icon.className = "fa-regular fa-eye";
                    togglePasswordButton.setAttribute("aria-label", "Mostrar contraseña");
                } else {
                    icon.className = "fa-regular fa-eye-slash";
                    togglePasswordButton.setAttribute("aria-label", "Ocultar contraseña");
                }
            });

            const imageModal = document.createElement("div");
            imageModal.className = "image-modal";
            imageModal.innerHTML = '<img src="" alt="Imagen ampliada">';
            document.body.appendChild(imageModal);

            imageModal.addEventListener("click", () => {
                imageModal.style.display = "none";
            });

            const showImageModal = (src, alt) => {
                const img = imageModal.querySelector("img");
                img.src = src;
                img.alt = alt;
                imageModal.style.display = "flex";
            };

            const generateSessionId = () => {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            };

            const validateEmailFormat = (email) => {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            };

            const transitionToChat = (email, userData = {}) => {
                userEmail = email;
                sessionId = generateSessionId();
                window.userData = userData;

                authScreen.classList.add("hidden");
                chatMessages.classList.remove("hidden");
                suggestedQuestionsContainer.classList.remove("hidden");
                chatInputArea.classList.remove("hidden");

                // Asegurar que el feedback trigger existe
                if (!document.getElementById("feedback-trigger")) {
                    const feedbackTriggerHTML = `
                        <div id="feedback-trigger" class="feedback-trigger hidden">
                            <button class="feedback-trigger-btn" id="open-feedback-btn">
                                <i class="fa-regular fa-star"></i>
                                ¿Te ayudé? Valora mi atención
                            </button>
                        </div>
                    `;
                    chatMessages.insertAdjacentHTML('beforeend', feedbackTriggerHTML);
                    const openFeedbackBtn = document.getElementById("open-feedback-btn");
                    if (openFeedbackBtn) {
                        openFeedbackBtn.addEventListener("click", openFeedbackModal);
                    }
                }

                passwordInput.value = '';
                emailInput.value = '';
                guestEmailInput.value = '';

                initializeChat(userData);
            };

            const logout = () => {
                // Resetear todas las variables de estado
                isChatInitialized = false;
                userEmail = "";
                sessionId = "";
                window.userData = {};
                feedbackTriggerShouldBeVisible = false;
                helpMessageClosed = false;
                helpMessageClicked = false;
                lastUserQuestion = "";
                lastBotResponse = "";
                
                // Limpiar todos los listeners de sugerencias antes de limpiar HTML
                const oldSuggestionButtons = suggestedQuestionsContainer.querySelectorAll(".suggestion-button");
                oldSuggestionButtons.forEach(btn => {
                    btn.onclick = null;
                });
                
                // Limpiar HTML completamente
                chatMessages.innerHTML = "";
                suggestedQuestionsContainer.innerHTML = "";
                chatInput.value = "";
                
                // Recrear el feedback trigger
                const feedbackTriggerHTML = `
                    <div id="feedback-trigger" class="feedback-trigger hidden">
                        <button class="feedback-trigger-btn" id="open-feedback-btn">
                            <i class="fa-regular fa-star"></i>
                            ¿Te ayudé? Valora mi atención
                        </button>
                    </div>
                `;
                chatMessages.innerHTML = feedbackTriggerHTML;
                
                // Resetear formularios de autenticación
                emailInput.value = "";
                passwordInput.value = "";
                guestEmailInput.value = "";
                emailInput.classList.remove("error");
                passwordInput.classList.remove("error");
                guestEmailInput.classList.remove("error");
                authError.classList.add("hidden");
                guestAuthError.classList.add("hidden");
                
                // Resetear visibilidad de elementos
                authScreen.classList.remove("hidden");
                chatMessages.classList.add("hidden");
                suggestedQuestionsContainer.classList.add("hidden");
                chatInputArea.classList.add("hidden");
                
                // Resetear estados del modal
                chatInput.disabled = false;
                feedbackOverlay.classList.remove("active");
                feedbackModal.classList.remove("active");
                
                // Reattach feedback button listener
                const feedbackTrigger = document.getElementById("feedback-trigger");
                const openFeedbackBtn = document.getElementById("open-feedback-btn");
                if (openFeedbackBtn) {
                    openFeedbackBtn.addEventListener("click", openFeedbackModal);
                }
                
                // Cerrar el modal del chatbot
                chatbotModal.classList.remove("open");
                
                // Mostrar mensaje de ayuda
                setTimeout(() => {
                    showHelpMessage();
                }, 500);
            };

            const validateWithLDAP = async (email, password) => {
                try {
                    const response = await fetch('https://api-ldap.uct.cl/validacion', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: email,
                            password: password
                        }),
                    });

                    if (!response.ok) {
                        return {
                            success: false,
                            message: 'Error al conectar con el servidor de autenticación'
                        };
                    }

                    const data = await response.json();

                    if (data.message === "Autenticación exitosa") {
                        return {
                            success: true,
                            userData: data.data
                        };
                    } else {
                        return {
                            success: false,
                            message: data.message || 'Credenciales inválidas. Por favor verifica tu correo y contraseña.'
                        };
                    }
                } catch (error) {
                    return {
                        success: false,
                        message: 'Error de conexión. Por favor inténtalo de nuevo.'
                    };
                }
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                const email = emailInput.value.trim().toLowerCase();
                const password = passwordInput.value;

                if (!validateEmailFormat(email)) {
                    emailInput.classList.add("error");
                    authError.textContent = "Por favor ingresa un correo electrónico válido";
                    authError.classList.remove("hidden");
                    return;
                }

                if (!password) {
                    passwordInput.classList.add("error");
                    authError.textContent = "Por favor ingresa tu contraseña";
                    authError.classList.remove("hidden");
                    return;
                }

                const submitButton = authForm.querySelector('.auth-button');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Validando credenciales...';

                const validation = await validateWithLDAP(email, password);

                submitButton.disabled = false;
                submitButton.textContent = originalText;

                if (!validation.success) {
                    emailInput.classList.add("error");
                    passwordInput.classList.add("error");
                    authError.textContent = validation.message;
                    authError.classList.remove("hidden");
                    return;
                }

                transitionToChat(email, validation.userData || {});
            };

            const handleGuestAuth = (e) => {
                e.preventDefault();
                const email = guestEmailInput.value.trim().toLowerCase();

                if (!validateEmailFormat(email)) {
                    guestEmailInput.classList.add("error");
                    guestAuthError.textContent = "Por favor ingresa un correo electrónico válido";
                    guestAuthError.classList.remove("hidden");
                    return;
                }

                transitionToChat(email, { isGuest: true });
            };

            let helpMessageTimer = null;
            let helpMessageClicked = false;

            const closeHelpMessage = (isManual = false) => {
                chatHelpMessage.classList.add("closed");
                chatHelpMessage.style.display = 'none';

                if (isManual) {
                    helpMessageClosed = true;
                    helpMessageClicked = true;
                    if (helpMessageTimer) {
                        clearTimeout(helpMessageTimer);
                    }
                    helpMessageTimer = setTimeout(() => {
                        helpMessageClosed = false;
                        helpMessageClicked = false;
                        if (!chatbotModal.classList.contains('open')) {
                            showHelpMessage();
                        }
                    }, 180000);
                }
            };

            const showHelpMessage = () => {
                chatHelpMessage.classList.remove("closed");
                chatHelpMessage.style.display = 'block';
                chatHelpMessage.style.opacity = '1';
                chatHelpMessage.style.pointerEvents = 'auto';
            };

            const hideHelpMessageTemporarily = () => {
                chatHelpMessage.classList.add("closed");
                chatHelpMessage.style.opacity = '0';
                chatHelpMessage.style.pointerEvents = 'none';
            };

            chatHelpMessage.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                closeHelpMessage(true);
            });

            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const isOpen = chatbotModal.classList.contains('open');

                        if (isOpen) {
                            if (!helpMessageClicked) {
                                hideHelpMessageTemporarily();
                            }
                        } else {
                            if (!helpMessageClosed) {
                                setTimeout(() => {
                                    if (!chatbotModal.classList.contains('open') && !helpMessageClicked) {
                                        showHelpMessage();
                                    }
                                }, 1000);
                            }
                        }
                    }
                });
            });

            observer.observe(chatbotModal, { attributes: true });

            const toggleChat = () => {
                chatbotModal.classList.toggle("open");
            };

            const extractFirstName = (cnField) => {
                if (!cnField) return null;
                
                const cnString = String(cnField).trim();
                if (!cnString) return null;
                
                const names = cnString.split(/\s+/);
                
                let firstName = null;
                
                if (names.length >= 3) {
                    firstName = names[2];
                }
                else if (names.length === 2) {
                    firstName = names[1];
                }
                else if (names.length === 1) {
                    firstName = names[0];
                }
                
                if (firstName) {
                    const lowerName = firstName.toLowerCase();
                    return lowerName.charAt(0).toUpperCase() + lowerName.slice(1);
                }
                
                return null;
            };

            const initializeChat = (userData = {}) => {
                let welcomeMessage = "¡Hola! Soy tu asistente virtual. ¿Cómo puedo ayudarte hoy?";
                
                if (userData && userData.cn) {
                    const firstName = extractFirstName(userData.cn);
                    if (firstName) {
                        welcomeMessage = `¡Hola ${firstName}! Soy tu asistente virtual. ¿Cómo puedo ayudarte hoy?`;
                    }
                }

                addMessage(welcomeMessage, "bot");

                const questions = [
                    "¿Qué créditos estudiantiles existen y dónde se pagan?",
                    "¿Dónde se descargan los pagarés de fondo de crédito universitario y/o créditos internos?",
                    "¿Qué es el Crédito Solidario Universitario y cuál es su objetivo?",
                ];

                questions.forEach((q) => {
                    const button = document.createElement("button");
                    button.textContent = q;
                    button.className = "suggestion-button";
                    button.onclick = () => handleSuggestedQuestion(q);
                    suggestedQuestionsContainer.appendChild(button);
                });

                isChatInitialized = true;
            };

            const clearSuggestions = () => {
                suggestedQuestionsContainer.innerHTML = "";
                suggestedQuestionsContainer.classList.add("hidden");
            };

            const makeLinksOpenInNewTab = (container = document) => {
                const links = container.querySelectorAll('a[href]');
                links.forEach(link => {
                    if (!link.target) {
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                    }
                });
            };

            const addMessage = (text, sender) => {
                const messageContainer = document.createElement("div");
                messageContainer.className = `message-container ${sender}`;

                const messageBubble = document.createElement("div");
                messageBubble.className = `message-bubble ${sender}`;

                if (sender === "user") {
                    messageBubble.textContent = text;
                } else {
                    messageBubble.className += " bot-message-content";
                    messageBubble.innerHTML = marked.parse(text);

                    setTimeout(() => {
                        const images = messageBubble.querySelectorAll("img");
                        images.forEach((img) => {
                            img.addEventListener("click", () => {
                                showImageModal(img.src, img.alt);
                            });

                            img.addEventListener("error", () => {
                                img.style.display = "none";
                            });
                        });

                        const videos = messageBubble.querySelectorAll("video");
                        videos.forEach((video) => {
                            video.addEventListener("error", () => {
                                video.style.display = "none";
                            });
                        });

                        makeLinksOpenInNewTab(messageBubble);
                    }, 100);
                }

                messageContainer.appendChild(messageBubble);
                
                // Buscar el feedback trigger en el DOM
                const feedbackTrigger = document.getElementById("feedback-trigger");
                if (feedbackTrigger && feedbackTrigger.parentNode === chatMessages) {
                    chatMessages.insertBefore(messageContainer, feedbackTrigger);
                } else {
                    chatMessages.appendChild(messageContainer);
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;

                return messageContainer;
            };

            const sendMessageToN8n = async (messageText) => {
                const typingIndicator = addMessage("", "bot");
                const bubble = typingIndicator.querySelector(".message-bubble");
                bubble.innerHTML = `
                    <div class="bot-loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                `;

                chatInput.disabled = true;
                const sendButton = chatForm.querySelector('.chat-send-button');
                if (sendButton) sendButton.disabled = true;

                try {
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            message: messageText,
                            email: userEmail,
                            sessionId: sessionId,
                            userData: window.userData || {},
                            timestamp: new Date().toISOString()
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`Error de red: ${response.statusText}`);
                    }

                    const responseText = await response.text();
                    let botReply = "";

                    try {
                        const data = JSON.parse(responseText);
                        botReply = data.reply || "No he podido procesar tu solicitud.";
                    } catch (jsonError) {
                        botReply = responseText;
                    }

                    if (!botReply.trim()) {
                        botReply = "He recibido una respuesta vacía.";
                    }

                    bubble.innerHTML = marked.parse(botReply);
                    lastBotResponse = botReply;

                    // Hacer scroll automático hacia abajo después de recibir la respuesta
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 50);

                    chatInput.disabled = false;
                    if (sendButton) sendButton.disabled = false;

                    feedbackTriggerShouldBeVisible = true;
                    getFeedbackTrigger()?.classList.remove("show");
                    setTimeout(() => {
                        if (feedbackTriggerShouldBeVisible) {
                            getFeedbackTrigger()?.classList.add("show");
                        }
                        // Hacer scroll nuevamente después de mostrar el botón de feedback
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 5000);

                    setTimeout(() => {
                        const images = bubble.querySelectorAll("img");
                        images.forEach((img) => {
                            img.addEventListener("click", () => {
                                showImageModal(img.src, img.alt);
                            });
                            img.addEventListener("error", () => {
                                img.style.display = "none";
                            });
                        });
                        const videos = bubble.querySelectorAll("video");
                        videos.forEach((video) => {
                            video.addEventListener("error", () => {
                                video.style.display = "none";
                            });
                        });

                        makeLinksOpenInNewTab(bubble);
                    }, 100);
                } catch (error) {
                    bubble.textContent =
                        "Lo siento, ha ocurrido un error. Inténtalo de nuevo más tarde.";
                    bubble.classList.add("error-message");

                    chatInput.disabled = false;
                    if (sendButton) sendButton.disabled = false;
                }
            };

            const handleFormSubmit = (e) => {
                e.preventDefault();
                const messageText = chatInput.value.trim();

                if (messageText) {
                    lastUserQuestion = messageText;
                    addMessage(messageText, "user");
                    clearSuggestions();
                    getFeedbackTrigger()?.classList.remove("show");
                    feedbackTriggerShouldBeVisible = false;
                    sendMessageToN8n(messageText);
                    chatInput.value = "";
                }
            };

            const handleSuggestedQuestion = (question) => {
                lastUserQuestion = question;
                addMessage(question, "user");
                clearSuggestions();
                getFeedbackTrigger()?.classList.remove("show");
                feedbackTriggerShouldBeVisible = false;
                sendMessageToN8n(question);
            };

            const openFeedbackModal = () => {
                feedbackOverlay.classList.add("active");
                feedbackModal.classList.add("active");
                showFeedbackDetails();
            };

            const closeFeedbackModal = () => {
                feedbackOverlay.classList.remove("active");
                feedbackModal.classList.remove("active");
            };

            getOpenFeedbackBtn()?.addEventListener("click", openFeedbackModal);
            closeFeedbackBtn.addEventListener("click", closeFeedbackModal);
            feedbackOverlay.addEventListener("click", closeFeedbackModal);

            const showFeedbackDetails = () => {
                feedbackModalContent.innerHTML = `
                    <div class="rating-container">
                        <label class="rating-label">¿Cómo calificarías la calidad de la respuesta?</label>
                        <div class="rating-stars" id="rating-stars">
                            <button class="star-btn" data-rating="1">★</button>
                            <button class="star-btn" data-rating="2">★</button>
                            <button class="star-btn" data-rating="3">★</button>
                            <button class="star-btn" data-rating="4">★</button>
                            <button class="star-btn" data-rating="5">★</button>
                        </div>
                        <textarea class="feedback-comment" placeholder="¿Algún comentario adicional? (Opcional)"></textarea>
                        <button class="feedback-submit" disabled>Enviar Valoración</button>
                    </div>
                `;

                setupStarRating();
                setupFeedbackSubmit();
                makeLinksOpenInNewTab(feedbackModalContent);
            };

            const setupStarRating = () => {
                const stars = feedbackModalContent.querySelectorAll(".star-btn");
                const submitBtn = feedbackModalContent.querySelector(".feedback-submit");
                const commentArea = feedbackModalContent.querySelector(".feedback-comment");

                const validateSubmit = () => {
                    const rating = parseInt(feedbackModalContent.dataset.rating || 0);
                    submitBtn.disabled = rating === 0 && commentArea.value.trim() === '';
                };

                commentArea.addEventListener('input', validateSubmit);

                stars.forEach((star) => {
                    star.addEventListener("click", () => {
                        const selectedRating = parseInt(star.dataset.rating);
                        feedbackModalContent.dataset.rating = selectedRating;

                        stars.forEach((s, i) => {
                            s.classList.toggle("active", i < selectedRating);
                        });
                        validateSubmit();
                    });

                    star.addEventListener("mouseenter", () => {
                        const hoverRating = parseInt(star.dataset.rating);
                        stars.forEach((s, i) => {
                            s.style.color = i < hoverRating ? "#fbbf24" : "#d1d5db";
                        });
                    });

                    star.addEventListener("mouseleave", () => {
                        const currentRating = parseInt(feedbackModalContent.dataset.rating || 0);
                        stars.forEach((s, i) => {
                            s.style.color = i < currentRating ? "#fbbf24" : "#d1d5db";
                        });
                    });
                });
            };

            const setupFeedbackSubmit = () => {
                const submitBtn = feedbackModalContent.querySelector(".feedback-submit");
                const commentArea = feedbackModalContent.querySelector(".feedback-comment");

                submitBtn.addEventListener("click", async () => {
                    submitBtn.disabled = true;
                    submitBtn.textContent = "Enviando...";

                    const rating = parseInt(feedbackModalContent.dataset.rating || 0);
                    const comment = commentArea.value.trim();

                    const feedbackData = {
                        type: "feedback",
                        sessionId: sessionId,
                        email: userEmail,
                        rating: rating,
                        comment: comment,
                        user_question: lastUserQuestion,
                        agent_response: lastBotResponse,
                        timestamp: new Date().toISOString()
                    };

                    try {
                        const response = await fetch(N8N_FEEDBACK_URL, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(feedbackData),
                        });

                        if (response.ok) {
                            feedbackModalContent.innerHTML = `
                                <div class="feedback-thanks">
                                    ✓ ¡Gracias por tu valoración!
                                </div>
                            `;
                            getFeedbackTrigger()?.classList.remove("show");
                            feedbackTriggerShouldBeVisible = false;

                            setTimeout(() => {
                                closeFeedbackModal();
                                logout();
                            }, 2000);
                        } else {
                            submitBtn.textContent = "Error al enviar";
                            submitBtn.disabled = false;
                        }
                    } catch (error) {
                        submitBtn.textContent = "Error al enviar";
                        submitBtn.disabled = false;
                    }
                });
            };

            openChatButton.addEventListener("click", toggleChat);
            closeChatButton.addEventListener("click", toggleChat);
            chatForm.addEventListener("submit", handleFormSubmit);
            authForm.addEventListener("submit", handleAuth);
            guestForm.addEventListener("submit", handleGuestAuth);

            chatInput.addEventListener('input', () => {
                if (chatInput.value.trim() !== '') {
                    getFeedbackTrigger()?.classList.remove('show');
                } else {
                    if (feedbackTriggerShouldBeVisible) {
                        getFeedbackTrigger()?.classList.add('show');
                    }
                }
            });

            emailInput.addEventListener("input", () => {
                emailInput.classList.remove("error");
                authError.classList.add("hidden");
            });

            passwordInput.addEventListener("input", () => {
                passwordInput.classList.remove("error");
                authError.classList.add("hidden");
            });

            guestEmailInput.addEventListener("input", () => {
                guestEmailInput.classList.remove("error");
                guestAuthError.classList.add("hidden");
            });
        });
    </script>

</body>
</html>